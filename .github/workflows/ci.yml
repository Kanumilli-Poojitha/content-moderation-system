name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    
    env:
      DATABASE_URL: postgresql://user:password@database:5432/moderation_db
      REDIS_URL: redis://redis:6379

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Build and start services with Docker Compose
        run: docker-compose up -d --build

      - name: Install Python test deps
        run: |
          python -m pip install --upgrade pip
          pip install pytest requests redis

      - name: Wait for services to be healthy
        run: |
          python - <<'PY'
          import time, os, sys
          import requests
          import redis

          # Services are behind docker-compose network aliases (database, redis, api, processor)
          # From host, connect to localhost since docker-compose exposes ports
          api_url = 'http://localhost:8000/health'
          redis_url = 'redis://localhost:6379'

          for attempt in range(60):
              api_ok = False
              redis_ok = False
              
              try:
                  resp = requests.get(api_url, timeout=2)
                  api_ok = (resp.status_code == 200)
              except Exception as e:
                  pass
              
              try:
                  redis.Redis.from_url(redis_url).ping()
                  redis_ok = True
              except Exception as e:
                  pass
              
              if api_ok and redis_ok:
                  print('All services healthy')
                  # Give processor extra time to subscribe to Redis channel
                  time.sleep(3)
                  sys.exit(0)
              
              print(f'Waiting for services... (attempt {attempt+1}/60): API={api_ok}, Redis={redis_ok}')
              time.sleep(2)
          
          print('Services did not become healthy in time')
          sys.exit(1)
          PY

      - name: Run tests
        env:
          PYTHONPATH: .
          DATABASE_URL: postgresql://user:password@localhost:5432/moderation_db
          REDIS_URL: redis://localhost:6379
        run: pytest -v

      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== API Logs ===" && docker-compose logs api || true
          echo "=== Processor Logs ===" && docker-compose logs processor || true
          echo "=== Redis Logs ===" && docker-compose logs redis || true
          echo "=== Database Logs ===" && docker-compose logs database || true

      - name: Tear down
        if: always()
        run: docker-compose down -v
